/*
 License and Terms of Use

 Copyright (c) 2010 Linden Research, Inc.
 Copyright (c) 2011 SignpostMarv

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

 This javascript makes use of the Second Life Map API, which is documented
 at http://wiki.secondlife.com/wiki/Map_API 

 Use of the Second Life Map API is subject to the Second Life API Terms of Use:
 https://wiki.secondlife.com/wiki/Linden_Lab_Official:API_Terms_of_Use

 Questions regarding this javascript, and any suggested improvements to it, 
 should be sent to the mailing list opensource-dev@list.secondlife.com
*/
Object.extend=function(a,c){for(property in c)a[property]=c[property];return a};
var SLURL={tileSize:256,gridEdgeSizeInRegions:1048576,mapFactor:90/1048576,minZoomLevel:8,maxZoomLevel:1,mouseHoverDelay:1E3,showHoverTips:false,backgroundColor:"#1D475F",debugMode:false,paranoidMode:false,getRegionCoordsByNameQueue:0,getRegionCoordsByNameVar:function(){return"slurlGetRegionCoordsByName_"+ ++SLURL.getRegionCoordsByNameQueue},getRegionCoordsByName:function(a,c,b){b=b||"slRegionPos_result";SLURL.loadScript("http://slurl.com/get-region-coords-by-name?var="+encodeURIComponent(b)+"&sim_name="+
encodeURIComponent(a),function(){c(window[b])})},getRegionNameByCoordsQueue:0,getRegionNameByCoordsVar:function(){return"slurlGetRegionNameByCoords_"+ ++SLURL.getRegionNameByCoordsQueue},getRegionNameByCoords:function(a,c,b,d){d=d||"slRegionName";SLURL.loadScript("http://slurl.com/get-region-name-by-coords?var="+encodeURIComponent(d)+"&grid_x="+encodeURIComponent(a)+"&grid_y="+encodeURIComponent(c),function(){b(window[d])})},gotoSLURL:function(a,c,b,d){function e(f,g,h){var i=["secondlife://"+encodeURIComponent(f),
g%1*256,h%1*256].join("/");a.addMapWindow(new SLURL.MapWindow("<b>"+f+"</b><br>"+(SLURL.debugMode?" x: "+Math.floor(g)+" y: "+Math.floor(h):"")+'<a href="'+i+'" class="teleport-button">Teleport Now</a>'),new SLURL.XYPoint(g,h))}if(typeof c=="number"){d=b;b=c;c=undefined}if(c==undefined)SLURL.getRegionNameByCoords(Math.floor(b),Math.floor(d),function(f){if(typeof f=="string")e(f,b,d);else if((f==null||f.error)&&SLURL.debugMode)alert("The coordinates of the SLURL ("+b+", "+d+") were not recognised as being in a SecondLife region.")},
SLURL.getRegionCoordsByNameVar());else{b=b||128;d=d||128;SLURL.getRegionCoordsByName(c,function(f){if(f.x&&f.y){b=f.x+b/256;d=f.y+d/256;SLURL.paranoidMode?SLURL.gotoSLURL(a,b,d):e(c,b,d)}else f.error&&SLURL.debugMode&&alert('No coordinates could be found for region "'+c+'"')},SLURL.getRegionNameByCoordsVar())}},loadScript:function(a,c){var b=document.createElement("script");b.src=a;b.type="text/javascript";if(c){b.onload=c;b.onreadystatechange=function(){if(b.readyState=="complete"||b.readyState==
"loaded")c()}}document.body.appendChild(b)},getTileUrl:function(a,c){var b=SLURL.convertZoom(c),d=Math.pow(2,b-1),e=a.x*d,f=a.y*d,g=SLURL.gridEdgeSizeInRegions;g-=g%d;f=g-f;f-=d;e-=e%d;f-=f%d;return["http://map.secondlife.com.s3.amazonaws.com","http://map.secondlife.com"][e/d%2]+["/map",b,e,f,"objects.jpg"].join("-")},convertZoom:function(a){return 8-a},XYPoint:function(a,c){this.x=a;this.y=c},RegionPoint:function(a,c,b){var d=this;SLURL.getRegionCoordsByName(a,function(e){if(SLURL.debugMode)if(e==
undefined)alert("API query for region coordinates failed");else e.error&&alert("API query returned an error");else if(typeof e=="object")if(e.x&&e.y){d.x=e.x+Math.min(Math.max(c,0),256)/256;d.y=e.y+Math.min(Math.max(b,0),256)/256;d.found=true}},SLURL.getRegionCoordsByNameVar())},Bounds:function(a,c,b,d){this.xMin=a||0;this.xMax=c||0;this.yMin=b||0;this.yMax=d||0},EuclideanProjection:function(a){this.pixelsPerLonDegree=[];this.pixelsPerLonRadian=[];this.pixelOrigo=[];this.tileBounds=[];for(var c=512,
b=1,d=0;d<a;d++){var e=c/2;this.pixelsPerLonDegree.push(c/360);this.pixelsPerLonRadian.push(c/(2*Math.PI));this.pixelOrigo.push(new GPoint(e,e));this.tileBounds.push(b);c*=2;b*=2}},Img:function(a,c,b,d){this.URL=a;this.width=c;this.height=b;this.alpha=!!d},Icon:function(a,c){this.mainImg=a;if(c)this.shadowImg=c},Marker:function(a,c,b){this.icons=a;this.slCoord=c;this.options=new MarkerOptions(b)},MarkerOptions:function(a){this.centerOnClick=this.onMouseOutHandler=this.onMouseOverHandler=this.clickHandler=
false;this.autopanOnClick=true;this.autopanPadding=45;this.verticalAlign="middle";this.horizontalAlign="center";this.zLayer=0;a&&Object.extend(this,a)},MapWindow:function(a,c){this.text=a;this.options=c},MapOptions:function(a){this.hasOverviewMapControl=this.hasPanningControls=this.hasZoomControls=true;this.onStateChangedClickHandler=null;a&&Object.extend(this,a);this.zoomMin=Math.min(this.zoomMin,SLURL.minZoomLevel);this.zoomMax=Math.max(this.zoomMax,SLURL.maxZoomLevel)},dragHandler:function(a){if(a.currentMapWindow&&
a.currentMapWindow.options&&a.currentMapWindow.options.closeOnMove){a.GMap.closeInfoWindow();delete a.currentMapWindow}},clickHandler:function(a,c,b){if(c){if(c.slMarker){b=c.slMarker;b.options.centerOnClick&&a.panOrRecenterToSLCoord(b.slCoord);b.options.clickHandler&&b.options.clickHandler(b)}}else{c=new SLURL.XYPoint;c._SetFromGLatLng(b);SLURL.gotoSLURL(a,c.x,c.y)}}};SLURL.RegionPoint.prototype=new SLURL.XYPoint;SLURL.EuclideanProjection.prototype=new GProjection;
SLURL.EuclideanProjection.prototype.fromLatLngToPixel=function(a,c){var b=a.lng()/SLURL.mapFactor,d=-a.lat()/SLURL.mapFactor;b=b*SLURL.tileSize;d=d*SLURL.tileSize;c=SLURL.convertZoom(c);var e=Math.pow(2,c-1);return new GPoint(b/e,d/e)};SLURL.EuclideanProjection.prototype.fromPixelToLatLng=function(a,c,b){c=SLURL.convertZoom(c);c=Math.pow(2,c-1);return new GLatLng(-(a.y*c/SLURL.tileSize*SLURL.mapFactor),a.x*c/SLURL.tileSize*SLURL.mapFactor,b)};
SLURL.EuclideanProjection.prototype.tileCheckRange=function(a){return a.x<0||a.y<0?false:true};SLURL.EuclideanProjection.prototype.getWrapWidth=function(a){return this.tileBounds[a]*SLURL.gridEdgeSizeInRegions};SLURL.XYPoint.prototype.GetGLatLng=function(){return new GLatLng(-(SLURL.gridEdgeSizeInRegions-this.y)*SLURL.mapFactor,this.x*SLURL.mapFactor)};
SLURL.XYPoint.prototype._SetFromGLatLng=function(a){this.x=a.lng()/SLURL.mapFactor;this.y=-a.lat()/SLURL.mapFactor;this.y=SLURL.gridEdgeSizeInRegions-this.y};SLURL.Bounds.prototype._SetFromGLatLngBounds=function(a){var c=new SLURL.XYPoint,b=new SLURL.XYPoint;c._SetFromGLatLng(a.getSouthWest());b._SetFromGLatLng(a.getNorthEast());this.xMin=c.x;this.yMin=c.y;this.xMax=b.x;this.yMax=b.y};SLURL.Img.prototype.isAlpha=function(){return this.alpha};SLURL.Icon.prototype.hasShadow=function(){return!!this.shadowImg};
SLURL.MapWindow.prototype.getGMapOptions=function(){return{maxWidth:this.options&&this.options.width?this.options.width:252}};
function SLMap(a,c){var b=this;if(GBrowserIsCompatible()){b.ID=null;b.showingHoverWindow=false;b.options=new SLURL.MapOptions(c);b.mapProjection=new SLURL.EuclideanProjection(18);var d=b.CreateMapTypes(),e=b.CreateMapDiv(a),f=true,g=true,h=true;b.GMap=new GMap2(e,{mapTypes:d,backgroundColor:SLURL.backgroundColor});b.GMap.slMap=b;b.currentMapWindow=null;b.voiceMarkers=[];if(b.options){g=!!b.options.hasPanningControls;f=!!b.options.hasZoomControls;h=!!b.options.hasOverviewMapControl}if(f||g)b.GMap.addControl(new GSmallMapControl);
h&&b.GMap.addControl(new GOverviewMapControl);b.GMap.enableContinuousZoom();b.GMap.enableScrollWheelZoom();b.GMap.setCenter(new GLatLng(0,0),16);b.GMap.addControl(new GMapTypeControl);GEvent.addListener(b.GMap,"click",function(i,j){SLURL.clickHandler(b,i,j)});GEvent.addListener(b.GMap,"moveend",function(){b.onStateChangedHandler()});if(SLURL.showHoverTips){GEvent.addListener(b.GMap,"mousemove",function(i){b.onMouseMoveHandler(i)});GEvent.addListener(this.GMap,"mouseout",function(i){b.onMouseOutHandler(i)})}GEvent.addListener(b.GMap,
"dragstart",function(){SLURL.dragHandler(b)});this.GMarkerManager=new GMarkerManager(this.GMap)}else{this.GMap=null;throw"Your browser is not supported";}}SLMap.prototype.onStateChangedHandler=function(){this.options&&this.options.onStateChangedHandler&&this.options.onStateChangedHandler()};SLMap.prototype.onMouseMoveHandler=function(a){this.resetHoverTimeout(true);this.hoverPos=a;this.showingHoverWindow&&this.GMap.closeInfoWindow()};SLMap.prototype.onMouseOutHandler=function(){this.clearHoverTimeout(true)};
SLMap.prototype.clearHoverTimeout=function(){if(this.ID!=null){window.clearTimeout(this.ID);this.ID=null}};SLMap.prototype.resetHoverTimeout=function(a){var c=this.ID!=null;this.clearHoverTimeout();if(c||a){var b=this;this.ID=window.setTimeout(function(){b.mousehoverHandler()},SLURL.mouseHoverDelay)}};SLMap.prototype.mousehoverHandler=function(){tilePos=new SLURL.XYPoint;tilePos._SetFromGLatLng(this.hoverPos);this.showTileToolTip()};SLMap.prototype.getRegionName=function(){return"Test Region Name"};
SLMap.prototype.showTileToolTip=function(){var a=this;this.ID=null;var c="";c=this.getRegionName();this.GMap.openInfoWindowHtml(this.hoverPos,c,{onCloseFn:function(){a.hoverWindowCloseHandler()}});this.showingHoverWindow=true};SLMap.prototype.hoverWindowCloseHandler=function(){this.showingHoverWindow=false;this.resetHoverTimeout(false)};
SLMap.prototype.CreateMapTypes=function(){var a=[],c=new GCopyrightCollection("SecondLife"),b=new GCopyright(1,new GLatLngBounds(new GLatLng(0,0),new GLatLng(-90,90)),0,"(C) 2007 - "+(new Date).getFullYear()+" Linden Lab");c.addCopyright(b);c=[new GTileLayer(c,10,16)];c[0].getTileUrl=SLURL.getTileUrl;c=new GMapType(c,this.mapProjection,"Land");c.getMinimumResolution=function(){return SLURL.convertZoom(SLURL.minZoomLevel)};c.getMaximumResolution=function(){return SLURL.convertZoom(SLURL.maxZoomLevel)};
a.push(c);return a};
SLMap.prototype.CreateMapDiv=function(a){var c=this,b=document.createElement("div");b.style.height="100%";if(c.options.showRegionSearchForm){var d=document.createElement("form"),e=document.createTextNode("Enter region name:"),f=document.createElement("span"),g=document.createElement("input"),h=document.createElement("input"),i=function(){g?c.gotoRegion(g.value):alert("Can't find textField!");return false};d.setAttribute("style","text-align:center;padding:4px;width:270px;margin-left:auto;margin-right:auto;background-color:#fff");d.onsubmit=
i;f.style.fontSize="80%";f.appendChild(e);g.value="Ahern";g.size=15;h.type="submit";h.value="Go!";h.onsubmit=i;d.appendChild(f);d.appendChild(g);d.appendChild(h);a.appendChild(d)}a.appendChild(b);return b};
SLMap.prototype.gotoRegion=function(a){var c=this,b="http://slurl.com/get-region-coords-by-name?var=slRegionPos_result&sim_name="+encodeURIComponent(a);SLURL.loadScript(b,function(){if(slRegionPos_result.error)alert("The region name '"+a+"' was not recognised.");else{var d=new SLURL.XYPoint(slRegionPos_result.x,slRegionPos_result.y);c.panOrRecenterToSLCoord(d)}})};
SLMap.prototype.centerAndZoomAtSLCoord=function(a,c){if(this.GMap!=null){c=this._forceZoomToLimits(c);this.GMap.setCenter(a.GetGLatLng(),SLURL.convertZoom(c))}};SLMap.prototype.disableDragging=function(){this.GMap!=null&&this.GMap.disableDragging()};SLMap.prototype.enableDragging=function(){this.GMap!=null&&this.GMap.enableDragging()};
SLMap.prototype.getViewportBounds=function(){if(this.GMap!=null){gLatLngBounds=this.GMap.getBounds();viewBounds=new SLURL.Bounds;viewBounds._SetFromGLatLngBounds(gLatLngBounds);return viewBounds}};SLMap.prototype.getMapCenter=function(){if(this.GMap!=null){gCenter=this.GMap.getCenter();center=new SLURL.XYPoint;center._SetFromGLatLng(gCenter);return center}};SLMap.prototype.clickMarker=function(a){SLURL.clickHandler(this,a.gmarker,a.gmarker.getPoint())};
SLMap.prototype.addMarker=function(a,c){if(this.GMap!=null){var b=a.icons[0],d=new GIcon;d.image=b.mainImg.URL;d.iconSize=new GSize(b.mainImg.width,b.mainImg.height);if(b.shadowImg){d.shadow=b.shadowImg.URL;d.shadowSize=new GSize(b.shadowImg.width,b.shadowImg.height)}else d.shadowSize=d.iconSize;b=d.iconSize.width/2;if(a.options.horizontalAlign=="left")b=0;else if(a.options.horizontalAlign=="right")b=d.iconSize.width;var e=d.iconSize.height/2;if(a.options.verticalAlign=="top")e=0;else if(a.options.verticalAlign==
"bottom")e=d.iconSize.height;d.iconAnchor=new GPoint(b,e);d.infoWindowAnchor=d.iconAnchor;b=a.slCoord.GetGLatLng();e=false;if(c||a.options.centerOnClick||a.options.clickHandler||a.options.onMouseOverHandler||a.options.onMouseOutHandler)e=true;var f=0;if(a.options.zLayer)f=a.options.zLayer;a.gmarker=new GMarker(b,{icon:d,clickable:e,draggable:false,zIndexProcess:function(){return f}});a.gmarker.slMarker=a;c&&GEvent.addListener(a.gmarker,"click",function(){a.gmarker.openInfoWindowHtml(c.text,c.getGMapOptions());
this.currentMapWindow=c});a.options.onMouseOverHandler&&GEvent.addListener(a.gmarker,"mouseover",function(){a.options.onMouseOverHandler(a)});a.options.onMouseOutHandler&&GEvent.addListener(a.gmarker,"mouseout",function(){a.options.onMouseOutHandler(a)});this.GMap.addOverlay(a.gmarker)}};SLMap.prototype.removeMarker=function(a){if(this.GMap!=null&&a.gmarker){this.GMap.removeOverlay(a.gmarker);a.gmarker=null}};SLMap.prototype.removeAllMarkers=function(){this.GMap!=null&&this.GMap.clearOverlays()};
SLMap.prototype.addMapWindow=function(a,c){if(this.GMap!=null){this.GMap.openInfoWindowHtml(c.GetGLatLng(),a.text,a.getGMapOptions());this.currentMapWindow=a}};SLMap.prototype.zoomIn=function(){return this.zoom(this.zoom()-1)};SLMap.prototype.zoomOut=function(){return this.zoom(this.zoom()+1)};SLMap.prototype.zoom=function(a){if(this.GMap){a&&this.GMap.setZoom(SLURL.convertZoom(this._forceZoomToLimits(a)));return SLURL.convertZoom(this.GMap.getZoom())}};
SLMap.prototype._forceZoomToLimits=function(a){if(this.options&&this.options.zoomMax)if(a<this.options.zoomMax)a=this.options.zoomMax;if(this.options&&this.options.zoomMin)if(a>this.options.zoomMin)a=this.options.zoomMin;return a};SLMap.prototype.panBy=function(a,c){if(this.GMap){var b=this.GMap.getCenter(),d=this.mapProjection.fromPixelToLatLng(new SLURL.XYPoint(a,c),this.GMap.getZoom());this.GMap.panTo(new GLatLng(b.lat()+d.lat(),b.lng()+d.lng()))}};
SLMap.prototype.panLeft=function(){this.panBy(-SLURL.tileSize,0)};SLMap.prototype.panRight=function(){this.panBy(SLURL.tileSize,0)};SLMap.prototype.panUp=function(){this.panBy(0,-SLURL.tileSize)};SLMap.prototype.panDown=function(){this.panBy(0,SLURL.tileSize)};SLMap.prototype.panOrRecenterToSLCoord=function(a){this.GMap!=null&&this.GMap.panTo(a.GetGLatLng())};
